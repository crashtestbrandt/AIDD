# PR Quality Gates — enforces Story/Task references and ADR linkage.
#
# Triggers on all PRs. Checks:
# 1. PR title or body contains a Story/Task reference (#123, STORY-123, etc.)
# 2. If architectural files changed, PR must reference an ADR (ADR-001, etc.)
# 3. ADR files must contain required sections (Title, Status, Context, etc.)
#
# Tune the regex patterns in the env block below to match your project conventions.

name: PR Quality Gates

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
    branches: ["**"]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  policy-checks:
    name: Enforce Story/Task refs & ADR usage
    runs-on: ubuntu-latest

    env:
      # Story/Task reference patterns: #123, STORY-123, TASK-456, GH-789, PROJ-123
      # Uses grep -P (Perl regex) for \b and \d support
      STORY_REF_REGEX: '(#\d+|\b(?:STORY|TASK|EPIC)-\d+\b|\b[A-Z][A-Z0-9]+-\d+\b|\bGH-\d+\b)'
      # ADR reference pattern: ADR-001, ADR-42, etc.
      ADR_REF_REGEX: '\bADR-\d+\b'
      # File paths that require an ADR link when changed
      ADR_REQUIRED_PATHS: |
        ^(contracts/.*\.(ya?ml|json|proto|graphql|gql))$
        ^(api/.*\.(ya?ml|json|proto|graphql|gql))$
        ^(schema/|db/|migrations/)
        ^(infrastructure/|infra/|ops/|k8s/|helm/|terraform/|pulumi/)
        ^(prompts/|prompt_registry/)
        ^(services/.*/contracts/.*)$
        ^(proto/.*\.proto)$
        ^(openapi/.*\.(ya?ml|json))$

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Gather PR metadata & changed files
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = pr.number;

            const body = (pr.body || "").trim();
            const title = (pr.title || "").trim();

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: prNumber, per_page: 100 }
            );
            const changed = files.map(f => f.filename);

            core.setOutput('body', body);
            core.setOutput('title', title);
            core.setOutput('changed', JSON.stringify(changed));

      - name: Evaluate policy
        id: eval
        env:
          PR_BODY: ${{ steps.meta.outputs.body }}
          PR_TITLE: ${{ steps.meta.outputs.title }}
          PR_CHANGED: ${{ steps.meta.outputs.changed }}
        run: |
          set -euo pipefail

          BODY="${PR_BODY}"
          TITLE="${PR_TITLE}"
          CHANGED_FILES="$(echo "${PR_CHANGED}" | jq -r '.[]?')"

          STORY_REF_REGEX=${STORY_REF_REGEX}
          ADR_REF_REGEX=${ADR_REF_REGEX}

          # Parse ADR-required path patterns from env, stripping comments
          mapfile -t ADR_RULES <<< "$(printf '%s\n' "${ADR_REQUIRED_PATHS}")"
          ADR_RULES_CLEAN=()
          for r in "${ADR_RULES[@]}"; do
            rr="$(echo "$r" | sed -E 's/#.*$//' | tr -d '\r')"
            [[ -n "$rr" ]] && ADR_RULES_CLEAN+=("$rr")
          done

          # Check if any changed file matches an ADR-required path
          need_adr=0
          adr_required_files=()
          if [[ -n "${CHANGED_FILES}" ]]; then
            while IFS= read -r file; do
              for rule in "${ADR_RULES_CLEAN[@]}"; do
                if echo "$file" | grep -Eq "$rule"; then
                  need_adr=1
                  adr_required_files+=("$file")
                  break
                fi
              done
            done <<< "$CHANGED_FILES"
          fi

          # Check for Story/Task reference in title or body
          has_story_ref=0
          if echo "$TITLE" | grep -Pq "$STORY_REF_REGEX" || echo "$BODY" | grep -Pq "$STORY_REF_REGEX"; then
            has_story_ref=1
          fi

          # Check for ADR reference in title or body
          has_adr_ref=0
          if echo "$TITLE" | grep -Pq "$ADR_REF_REGEX" || echo "$BODY" | grep -Pq "$ADR_REF_REGEX"; then
            has_adr_ref=1
          fi

          echo "need_adr=$need_adr" >> $GITHUB_OUTPUT
          echo "has_story_ref=$has_story_ref" >> $GITHUB_OUTPUT
          echo "has_adr_ref=$has_adr_ref" >> $GITHUB_OUTPUT

          # Build summary for PR comment
          {
            echo "### PR Quality Gate Results"
            echo ""
            echo "- Story/Task reference present: $([[ $has_story_ref -eq 1 ]] && echo '✅' || echo '❌')"
            if [[ $need_adr -eq 1 ]]; then
              echo "- ADR required (triggered by file changes): ✅"
              echo "  - Files triggering ADR requirement:"
              for f in "${adr_required_files[@]}"; do echo "    - \`$f\`"; done
              echo "- ADR reference present in title/body: $([[ $has_adr_ref -eq 1 ]] && echo '✅' || echo '❌')"
            else
              echo "- ADR required: ❌ (no architectural/contract/infra/schema/prompt changes detected)"
            fi
            echo ""
            echo "**Patterns**"
            echo "- Story/Task: \`${STORY_REF_REGEX}\` (e.g., \`#123\`, \`STORY-42\`, \`TASK-7\`, \`PROJ-123\`)"
            echo "- ADR: \`${ADR_REF_REGEX}\` (e.g., \`ADR-001\`)"
          } > gate_summary.md

          # Fail if references are missing
          fail=0
          if [[ $has_story_ref -ne 1 ]]; then
            echo "::error title=Missing Story/Task reference::Add a Story or Task reference to the PR title or body (e.g., #123, STORY-123, TASK-456, PROJ-123)."
            fail=1
          fi
          if [[ $need_adr -eq 1 && $has_adr_ref -ne 1 ]]; then
            echo "::error title=ADR required but not linked::Architectural/contract/infra/schema/prompt changes detected. Link an ADR in the PR (e.g., ADR-042)."
            fail=1
          fi

          if [[ $fail -eq 1 ]]; then
            exit 1
          fi

      - name: Comment results on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('gate_summary.md', 'utf8');
            const pr = context.payload.pull_request;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body
            });

  adr-lint:
    name: Lint ADR documents
    if: always()
    needs: policy-checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check ADR required sections
        run: |
          set -euo pipefail
          shopt -s nullglob
          fails=0
          for f in docs/adr/ADR-*.md; do
            echo "Linting $f"
            for h in "## Title" "## Status" "## Context" "## Decision" "## Rationale" "## Consequences" "## References"; do
              if ! grep -q "^$h" "$f"; then
                echo "::error file=$f,title=Missing heading::$h"
                fails=1
              fi
            done
          done
          exit $fails
